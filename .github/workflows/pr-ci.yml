name: PR CI (reviewdog + tests)

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4

      # 1) Checkstyle 실행해서 XML 리포트 생성 (실패해도 다음으로 넘어가게)
      - name: Run checkstyle (generate XML)
        continue-on-error: true
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon

      # 2) reviewdog 설치
      - name: Setup reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      # 3) checkstyle 결과를 PR에 라인 주석으로 달기
      - name: Report checkstyle(main) to PR
        if: always()
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f build/reports/checkstyle/main.xml ]; then
            cat build/reports/checkstyle/main.xml | reviewdog \
              -f=checkstyle \
              -name="checkstyle(main)" \
              -reporter=github-pr-check \
              -filter-mode=diff_context
          fi

      - name: Report checkstyle(test) to PR
        if: always()
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f build/reports/checkstyle/test.xml ]; then
            cat build/reports/checkstyle/test.xml | reviewdog \
              -f=checkstyle \
              -name="checkstyle(test)" \
              -reporter=github-pr-check \
              -filter-mode=diff_context
          fi

      # 4) 테스트 실행 (여기서 실패하면 PR이 빨간불)
      - name: Run tests
        run: ./gradlew test --no-daemon